version: '3'

services:
  reverse-proxy:
    image: traefik:v2.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.docker.defaultRule=Host(`{{.Name}}.sre.kz`)"
    restart: always
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
  ci:
    image: drone/drone:1
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ci.rule=Host(`ci.sre.kz`)"
    ports:
      - "80"
      - "443"
    volumes:
      - /var/lib/drone:/data
    environment:
      DRONE_AGENTS_ENABLED: "true"
      DRONE_GITHUB_SERVER: "https://github.com"
      DRONE_GITHUB_CLIENT_ID:
      DRONE_GITHUB_CLIENT_SECRET:
      DRONE_RPC_SECRET:
      DRONE_SERVER_HOST: "ci.sre.kz"
      DRONE_SERVER_PROTO: "http"
      DRONE_USER_FILTER: "anuar45"
      
  whoami:
    image: containous/whoami
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.sre.kz`)"
